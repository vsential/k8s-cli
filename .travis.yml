language: minimal
os:
  - linux
dist: bionic
branches:
  except:
    - master
env:
  - IMAGE_NAME=$REGISTRY_USER/k8s-cli
services:
  - docker
install: []
jobs:
  include:
    - stage: Build Docker Image
      script:
        - docker build -t $IMAGE_NAME .
    - stage: Test Docker Image
      script:
        - docker run $IMAGE_NAME:$TRAVIS_BRANCH version --client

before_deploy:
  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
  - git_sha="$(git rev-parse --short HEAD)"
  - docker tag $IMAGE_NAME $IMAGE_NAME:$TRAVIS_BRANCH
  - docker tag $IMAGE_NAME $IMAGE_NAME:${git_sha}-release
deploy:
  provider: script
  script: docker push $IMAGE_NAME:$TRAVIS_BRANCH
  on:
    branch: $TRAVIS_BRANCH